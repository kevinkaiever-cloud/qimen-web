<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥‡é—¨éç”²Â·å®—å¸ˆæ’ç›˜ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Serif+SC:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        :root {
            --bg-body: #f0f9ff;
            --bg-panel: #ffffff;
            --primary: #0f172a;
            --accent: #0ea5e9;
            --accent-light: #38bdf8;
            --accent-deep: #0284c7;
            --border: #bae6fd;
            --border-light: #e0f2fe;
            --ink: #0f172a;
            --text-secondary: #64748b;
            --wood: #22c55e; --fire: #f97316; --earth: #a16207; --metal: #0ea5e9; --water: #2563eb;
        }
        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes float { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        body {
            background: linear-gradient(165deg, #f0f9ff 0%, #e0f2fe 30%, #f0f9ff 70%, #e0f2fe 100%);
            background-attachment: fixed;
            color: var(--primary);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Inter", "PingFang SC", "Microsoft YaHei", sans-serif;
            margin: 0; padding: 0; font-size: 17px; line-height: 1.47059; font-weight: 400; letter-spacing: -0.022em;
            min-height: 100vh;
        }
        .container { max-width: 680px; margin: 0 auto; padding: 48px 24px 80px; display: flex; flex-direction: column; min-height: 100vh; animation: fadeIn 0.6s cubic-bezier(0.25,0.1,0.25,1); }

        .page-title {
            text-align: center; margin: 0 0 12px; font-size: 2.5rem; font-weight: 700; color: var(--ink);
            letter-spacing: -0.025em; line-height: 1.1;
        }
        .page-subtitle {
            text-align: center; font-size: 1.25rem; color: var(--text-secondary); margin-bottom: 32px;
            font-weight: 400; letter-spacing: -0.01em;
        }

        .badge-tech {
            align-self: center;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 8px 18px;
            border-radius: 980px;
            background: linear-gradient(135deg, rgba(14,165,233,0.15) 0%, rgba(56,189,248,0.08) 100%);
            border: 1px solid rgba(14,165,233,0.3);
            font-size: 14px;
            color: var(--ink);
            margin-bottom: 40px;
            font-weight: 500;
        }
        .badge-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 10px rgba(14,165,233,0.5);
        }

        .view-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
        }
        .view-tab-btn {
            flex: 1;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #fff;
            padding: 16px 20px;
            font-size: 17px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.25s cubic-bezier(0.25,0.1,0.25,1);
        }
        .view-tab-btn span.icon { font-size: 20px; }
        .view-tab-btn.active {
            background: linear-gradient(135deg, #0284c7 0%, #0ea5e9 100%);
            color: #fff;
            border-color: #0369a1;
            box-shadow: 0 4px 16px rgba(14,165,233,0.35);
        }
        .view-tab-btn:not(.active):hover {
            background: linear-gradient(180deg, #e0f2fe 0%, #bae6fd 100%);
            border-color: var(--accent-light);
            color: var(--accent-deep);
        }

        .guide-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%);
            border: 1px solid rgba(14,165,233,0.25);
            border-radius: 16px;
            padding: 24px 28px;
            margin-bottom: 32px;
            font-size: 15px;
            color: var(--ink);
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }
        .guide-icon { font-size: 1.5em; line-height: 1; }
        .guide-text strong { color: var(--ink); font-weight: 600; }

        .control-card {
            background: linear-gradient(180deg, rgba(255,255,255,0.98) 0%, rgba(240,249,255,0.95) 100%);
            border-radius: 20px;
            padding: 32px 36px;
            margin-bottom: 32px;
            box-shadow: 0 8px 32px rgba(14,165,233,0.12), 0 0 0 1px rgba(14,165,233,0.08);
        }
        .form-group { margin-bottom: 24px; }
        .form-group:last-of-type { margin-bottom: 28px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 10px; letter-spacing: -0.01em; }
        .flex-row { display: flex; gap: 12px; }
        .flex-1 { flex: 1; }

        input, select, textarea {
            width: 100%; box-sizing: border-box; padding: 14px 16px;
            border: 1px solid var(--border); border-radius: 12px;
            font-size: 17px; font-family: inherit;
            background: #fff;
            appearance: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--accent-light);
            box-shadow: 0 0 0 4px rgba(14,165,233,0.2);
        }
        textarea { resize: vertical; min-height: 80px; }

        .btn-submit {
            width: 100%;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: #fff;
            border: none;
            padding: 18px 24px;
            border-radius: 14px;
            font-weight: 600;
            font-size: 17px;
            cursor: pointer;
            margin-top: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            box-shadow: 0 6px 24px rgba(14,165,233,0.4);
            transition: transform 0.15s, box-shadow 0.2s;
        }
        .btn-submit:hover { transform: scale(1.01); box-shadow: 0 8px 28px rgba(14,165,233,0.5); }
        .btn-submit:active { transform: scale(0.99); }

        .pan-header {
            background: linear-gradient(180deg, #ffffff 0%, #f0f9ff 100%);
            padding: 28px 32px;
            border-radius: 20px;
            margin-bottom: 24px;
            border: 1px solid rgba(14,165,233,0.15);
            box-shadow: 0 4px 20px rgba(14,165,233,0.1);
            border-top: 3px solid var(--accent);
        }
        .ph-title { font-size: 1.15em; font-weight: 600; color: var(--ink); border-bottom: 1px dashed var(--border); padding-bottom: 16px; margin-bottom: 16px; }
        .ph-info { display: flex; flex-wrap: wrap; gap: 12px; font-size: 15px; color: var(--text-secondary); }
        .ph-tag {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 8px 16px;
            border-radius: 10px;
            font-size: 14px;
            color: var(--ink);
            border: 1px solid rgba(14,165,233,0.15);
        }
        .highlight { color: var(--accent); font-weight: 600; }
        .bazi-font { font-family: "Noto Serif SC", serif; font-size: 1.1em; letter-spacing: 1px; color: var(--ink); }

        .grid-box {
            width: 100%; aspect-ratio: 1/1;
            background: linear-gradient(145deg, #ffffff 0%, #f0f9ff 50%, #e0f2fe 100%);
            border: 2px solid rgba(14,165,233,0.25);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 0;
            box-shadow: 0 8px 28px rgba(14,165,233,0.12);
            border-radius: 20px;
            overflow: hidden;
        }
        .cell {
            position: relative;
            border: 1px solid var(--border);
            margin: -1px 0 0 -1px;
            padding: 8px;
            display: grid;
            grid-template-columns: 26px 1fr 30px;
            gap: 4px;
            background: #fff;
        }
        .cell-left {
            display: flex; align-items: center; justify-content: center;
            background: linear-gradient(180deg, #f0f9ff 0%, #e0f2fe 100%);
            border-right: 1px solid var(--border);
        }
        .font-gua { font-size: 0.9em; font-weight: 600; color: var(--text-secondary); writing-mode: vertical-lr; font-family: "Noto Serif SC", serif; }
        .cell-mid { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; }
        .font-god { font-size: 0.8em; font-weight: 600; }
        .font-star { font-size: 0.9em; color: var(--ink); }
        .font-door { font-size: 1.1em; font-weight: 600; font-family: "Noto Serif SC", serif; }
        .cell-right {
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
            background: linear-gradient(180deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 1px solid var(--border);
        }
        .stem-char { font-family: "Noto Serif SC", serif; font-size: 1.1em; font-weight: 600; line-height: 1; }
        .sky-group { display: flex; flex-direction: column; align-items: center; }

        .mark-ma { position: absolute; bottom: 6px; left: 6px; background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: #fff; font-size: 11px; padding: 4px 8px; border-radius: 8px; font-weight: 600; }
        .mark-kong { position: absolute; top: 6px; left: 6px; border: 1px solid var(--border); color: var(--text-secondary); font-size: 11px; padding: 4px 8px; border-radius: 8px; }

        .wx-wood { color: var(--wood); } .wx-fire { color: var(--fire); } .wx-earth { color: var(--earth); }
        .wx-metal { color: var(--metal); } .wx-water { color: var(--water); }
        .center-cell { display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(145deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid rgba(14,165,233,0.2); }

        #aiResult {
            margin-top: 28px;
            padding: 28px 32px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0f9ff 100%);
            border-radius: 20px;
            font-size: 16px;
            line-height: 1.6;
            color: var(--ink);
            border: 1px solid rgba(14,165,233,0.15);
            border-left: 4px solid var(--accent);
            box-shadow: 0 6px 24px rgba(14,165,233,0.1);
        }
        .ai-header { font-weight: 600; color: var(--accent-deep); margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid rgba(14,165,233,0.2); font-size: 1.1rem; }
        #aiResult p { margin: 0.8em 0; }

        /* è‚¡å¸‚é¢„æµ‹ */
        .stock-section-header { font-size: 15px; color: var(--text-secondary); padding-bottom: 8px; border-bottom: 1px dashed var(--border); margin-bottom: 24px; }
        .stock-result-card {
            margin-top: 24px;
            padding: 28px 32px;
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 50%, #e0f2fe 100%);
            border-radius: 20px;
            border: 1px solid rgba(14,165,233,0.15);
            box-shadow: 0 6px 24px rgba(14,165,233,0.1);
        }
        .stock-result-title { font-weight: 600; font-size: 1.15rem; color: var(--ink); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .stock-metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px; }
        .stock-metric-item {
            background: rgba(255,255,255,0.9);
            padding: 20px 24px;
            border-radius: 14px;
            border: 1px solid rgba(14,165,233,0.12);
            box-shadow: 0 2px 8px rgba(14,165,233,0.05);
        }
        .stock-metric-label { font-size: 13px; color: var(--text-secondary); margin-bottom: 6px; }
        .stock-metric-value { font-size: 17px; font-weight: 600; color: var(--ink); }
        .stock-metric-support .stock-metric-value { color: #059669; }
        .stock-metric-resistance .stock-metric-value { color: #dc2626; }
        .stock-metric-tendency { grid-column: 1 / -1; }
        .stock-summary { font-size: 14px; white-space: pre-line; color: var(--text-secondary); border-top: 1px dashed rgba(14,165,233,0.3); padding-top: 20px; margin-top: 20px; line-height: 1.6; }
        .stock-chart-wrapper {
            margin-top: 24px;
            border-radius: 20px;
            overflow: hidden;
            background: linear-gradient(180deg, #ffffff 0%, #f8fcff 100%);
            border: 1px solid rgba(14,165,233,0.15);
            box-shadow: 0 6px 24px rgba(14,165,233,0.1);
        }
        .stock-chart-header { padding: 16px 24px; background: linear-gradient(90deg, rgba(14,165,233,0.08) 0%, transparent 100%); font-size: 15px; font-weight: 600; color: var(--accent-deep); }
        .stock-chart-body { width: 100%; height: 280px; min-height: 260px; padding: 16px; box-sizing: border-box; }
        .stock-ai-box {
            margin-top: 24px;
            padding: 28px 32px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0f9ff 100%);
            border-radius: 20px;
            font-size: 15px;
            line-height: 1.7;
            color: var(--ink);
            border: 1px solid rgba(14,165,233,0.2);
            box-shadow: 0 6px 24px rgba(14,165,233,0.08);
            animation: fadeIn 0.4s ease-out;
        }
        .stock-ai-title { font-weight: 600; font-size: 1.1rem; color: var(--accent-deep); margin-bottom: 16px; }
        .stock-zone-card {
            margin-bottom: 20px;
            padding: 20px 24px;
            border-radius: 14px;
            background: rgba(255,255,255,0.9);
            border: 1px dashed rgba(14,165,233,0.35);
            font-size: 14px;
            color: #0369a1;
        }
        .stock-zone-card .stock-metric-value { font-size: 16px; }
        .stock-disclaimer { font-size: 13px; color: var(--text-secondary); line-height: 1.5; }
        .analysis-mode-row { display: flex; flex-wrap: wrap; gap: 16px; align-items: center; }
        .mode-opt { display: inline-flex; align-items: center; gap: 8px; font-size: 15px; color: var(--ink); cursor: pointer; }
        .mode-opt input { width: auto; }
        .knowledge-hint { margin: 10px 0 0; font-size: 0.85rem; color: #64748b; line-height: 1.5; }
        .pay-modal { position: fixed; inset: 0; z-index: 9999; background: rgba(15,23,42,0.6); display: flex; align-items: center; justify-content: center; padding: 20px; }
        .pay-modal-content { background: #fff; border-radius: 20px; padding: 28px 32px; max-width: 380px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.2); border: 1px solid var(--border); }
        .pay-modal-title { font-size: 1.25rem; font-weight: 600; color: var(--ink); margin-bottom: 12px; }
        .pay-modal-desc { font-size: 14px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 8px; }
        .pay-amount { color: #059669; font-size: 1.1em; }
        .pay-modal-code-line { font-size: 15px; margin-bottom: 16px; padding: 10px 14px; background: #f0fdf4; border-radius: 10px; border: 1px solid #bbf7d0; }
        .pay-unlock-code { color: #047857; font-size: 1.2em; letter-spacing: 0.15em; }
        .pay-modal-code-hint { font-size: 12px; color: #64748b; margin-left: 6px; }
        .pay-modal-paid-btn { width: 100%; padding: 12px 16px; margin-bottom: 16px; border-radius: 10px; border: 1px solid #059669; background: #f0fdf4; color: #047857; font-size: 15px; font-weight: 600; cursor: pointer; }
        .pay-modal-paid-btn:hover { background: #dcfce7; }
        .pay-modal-qr-wrap { text-align: center; margin: 16px 0; min-height: 180px; }
        .pay-modal-qr { max-width: 200px; height: auto; border-radius: 12px; }
        .pay-modal-qr-placeholder { font-size: 13px; color: #94a3b8; }
        .pay-modal-account { font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; }
        .pay-modal-input-wrap { display: flex; gap: 10px; margin-bottom: 8px; }
        .pay-modal-input { flex: 1; padding: 12px 14px; border-radius: 10px; border: 1px solid var(--border); font-size: 15px; }
        .pay-modal-btn { padding: 12px 20px; border-radius: 10px; background: linear-gradient(135deg,#0ea5e9,#0284c7); color: #fff; border: none; font-weight: 600; cursor: pointer; }
        .pay-modal-msg { font-size: 13px; min-height: 20px; margin-bottom: 8px; }
        .pay-modal-msg.ok { color: #059669; }
        .pay-modal-msg.err { color: #dc2626; }
        .pay-modal-close { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: #f8fafc; cursor: pointer; font-size: 14px; }
        .brief-mode-tip { padding: 16px 20px; font-size: 15px; color: var(--text-secondary); line-height: 1.6; background: #f8fafc; border-radius: 12px; margin-top: 12px; border: 1px dashed var(--border); }
        /* æ‰‹æœºç«¯æ–‡å­—å¯è¯»æ€§ */
        @media (max-width: 768px) {
            body { font-size: 18px; line-height: 1.6; }
            .container { padding: 24px 16px 60px; }
            .stock-ai-box { font-size: 16px; line-height: 1.8; padding: 20px 18px; }
            .stock-ai-box p, .stock-ai-box li { font-size: 16px; line-height: 1.8; margin-bottom: 0.75em; }
            .stock-ai-title { font-size: 1.15rem; margin-bottom: 14px; }
            .stock-zone-card { font-size: 15px; padding: 18px 16px; }
            .stock-zone-card .stock-metric-value { font-size: 17px; }
            .stock-disclaimer { font-size: 14px !important; line-height: 1.6; color: #475569; }
            .stock-result-card, .stock-summary { font-size: 16px; line-height: 1.75; }
            .stock-metric-label { font-size: 14px; }
            .stock-metric-value { font-size: 18px; }
            .stock-chart-body { height: 260px; min-height: 220px; }
            .control-card { padding: 24px 20px; }
            .guide-box { font-size: 16px; padding: 18px 20px; }
            .pan-content, .interpret-content { font-size: 16px; line-height: 1.75; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="page-title">å¥‡é—¨éç”² Â· å®—å¸ˆæ’ç›˜</h1>
    <p class="page-subtitle">çœŸå¤ªé˜³æ—¶ Â· ä¹å®«æ ¼å±€ Â· AI è§£è¯»</p>
    <div class="badge-tech">
        <span class="badge-dot"></span>
        <span>AI å¥‡é—¨æ¨æ¼” Â· è‚¡å¸‚ç›˜ä½æ¨¡æ‹Ÿ Â· ç§‘æŠ€åŠ æŒçš„ä¸œæ–¹æ•°æœ¯</span>
    </div>

    <div class="view-tabs">
        <button id="tab-qimen" class="view-tab-btn active" onclick="switchView('qimen')">
            <span class="icon">â˜¯ï¸</span><span>å¥‡é—¨é—®äº‹</span>
        </button>
        <button id="tab-stock" class="view-tab-btn" onclick="switchView('stock')">
            <span class="icon">ğŸ“ˆ</span><span>è‚¡å¸‚é¢„æµ‹</span>
        </button>
    </div>

    <!-- å¥‡é—¨é—®äº‹æ¿å— -->
    <div id="qimenSection">
        <div class="guide-box">
            <div class="guide-icon">ğŸ””</div>
            <div class="guide-text">
                <strong>æ’ç›˜ç¦å¿Œï¼šä¸€ç›˜åªå ä¸€äº‹ï¼</strong><br>
                å¥‡é—¨ç›˜é¢ä¿¡æ¯é‡å¤§ï¼Œä½†è½å®«åªèƒ½å¯¹åº”ä¸€ç±»è±¡æ„ã€‚æ±‚æµ‹ä»€ä¹ˆå°±é—®ä»€ä¹ˆï¼Œ<strong>åˆ‡å‹¿</strong>åœ¨åŒä¸€ä¸ªç›˜é‡Œæ—¢é—®è´¢è¿åˆé—®æ„Ÿæƒ…ï¼Œå¦åˆ™ä¿¡æ¯æ··æ‚ï¼Œæ–­è¯­å¿…é”™ã€‚
            </div>
        </div>

        <div class="control-card">
        <div class="form-group">
            <label>1. é—®äº‹ä¸»é¢˜ (å¿…å¡«ï¼Œç”¨äºå¼•å¯¼ AI èšç„¦)</label>
            <textarea id="userQuestion" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³é—®è¿‘æœŸçš„è´¢è¿å¦‚ä½•ï¼Ÿæˆ–è€…ï¼šè¿™ä¸ªå·¥ä½œé¡¹ç›®èƒ½ä¸èƒ½æˆï¼Ÿ(è¯·å…·ä½“æè¿°ï¼Œåªé—®ä¸€ä»¶äº‹)"></textarea>
        </div>

        <div class="form-group">
            <label>2. é—®äº‹æ—¶é—´ (è‡ªåŠ¨æ ¡å‡†çœŸå¤ªé˜³æ—¶)</label>
            <input type="datetime-local" id="askTime">
        </div>

        <div class="form-group">
            <label>3. é—®äº‹åœ°ç‚¹ (ç»åº¦æ ¡å‡†æ ¸å¿ƒ)</label>
            <div class="flex-row">
                <select id="provinceSel"></select>
                <select id="citySel"></select>
            </div>
        </div>

        <div class="form-group">
            <label>4. å‘½ä¸»å‡ºç”Ÿ (é€‰å¡«ï¼Œæ’å…«å­—ç”¨)</label>
            <input type="datetime-local" id="birthTime">
        </div>

        <div class="form-group">
            <label>5. DeepSeek API Key (AI è§£è¯»å¿…å¡«)</label>
            <input type="password" id="apiKey" placeholder="sk-...">
        </div>

        <div class="form-group">
            <label>6. åˆ†ææ·±åº¦</label>
            <div class="analysis-mode-row">
                <label class="mode-opt"><input type="radio" name="qimenMode" value="brief" checked> ç®€è¦åˆ†æï¼ˆå…è´¹ï¼‰</label>
                <label class="mode-opt"><input type="radio" name="qimenMode" value="detail"> è¯¦ç»†åˆ†æï¼ˆä»˜è´¹ï¼‰</label>
            </div>
            <p class="knowledge-hint">æ–­äº‹é€»è¾‘æ¥è‡ªé›¨éœ–è¯¾ç¨‹å­—å¹•æ•´ç†ï¼Œä¿è¯è§£è¯»æ—¶æŒ‰æ­¥éª¤ã€æŒ‰é€»è¾‘è¾“å‡ºï¼›çŸ¥è¯†åº“å«ç”¨ç¥å–æ³•ã€è§£ç›˜æ­¥éª¤ã€ä¹å®«è±¡æ„ã€ç©ºäº¡åº”æœŸç­‰ã€‚</p>
        </div>

        <button class="btn-submit" onclick="runSystem()">
            <span>â˜¯ï¸</span> å¼€å§‹æ’ç›˜ä¸åˆ†æ
        </button>
        </div>

        <div id="panArea" style="display:none;">
        <div class="pan-header">
            <div class="ph-title" id="dateInfo"></div>
            <div style="margin-bottom:8px;">
                <span class="ph-tag">é—®äº‹å…«å­—</span> <span class="bazi-font" id="baziInfo"></span>
            </div>
            <div id="birthRow" style="display:none; margin-bottom:8px;">
                <span class="ph-tag">å‘½ä¸»å…«å­—</span> <span class="bazi-font" id="birthInfo"></span>
            </div>
            <div class="ph-info">
                <span id="jieqiInfo"></span>
                <span id="xunInfo"></span>
                <span id="zhifuInfo" class="highlight"></span>
            </div>
            <div id="solarNote" style="font-size:0.8em; color:#999; margin-top:6px; text-align:right;"></div>
        </div>

        <div class="grid-box" id="grid"></div>

        <div id="aiResult" style="display:none;"></div>

            <!-- å¥‡é—¨ AI è¿½é—®å¯¹è¯æ¡† -->
            <div id="aiChatCard" style="display:none;margin-top:24px;padding:24px 28px;background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);border-radius:20px;border:1px solid rgba(14,165,233,0.25);">
                <div style="font-size:15px;font-weight:600;color:#0369a1;margin-bottom:10px;">ç»§ç»­å‘ AI å®—å¸ˆè¿½é—®</div>
                <div style="font-size:14px;color:#475569;margin-bottom:12px;">
                    å¯åœ¨<strong>åŒä¸€ç›˜</strong>åŸºç¡€ä¸Šè¿½é—®ç»†èŠ‚ï¼Œä¾‹å¦‚ï¼š<br>
                    â€œå¦‚æœåšæŒè¿™ä»½å·¥ä½œä¸‰ä¸ªæœˆï¼Œå¤§è‡´ä¼šæ€æ ·ï¼Ÿâ€ã€â€œæ¢ä¸€ä¸ªæ›´æ¿€è¿›çš„æ“ä½œæ–¹å¼é£é™©åœ¨å“ªï¼Ÿâ€ ç­‰ã€‚<br>
                    è¯·ä»ç„¶éµå®ˆâ€œä¸€ç›˜ä¸€äº‹â€ï¼Œä¸è¦æ··å…¥å…¨æ–°é—®é¢˜ã€‚
                </div>
                <textarea id="followQuestion" placeholder="è¯·è¾“å…¥æƒ³è¿½é—®çš„å…·ä½“é—®é¢˜ï¼Œä¾‹å¦‚ï¼šè¿™ä»¶äº‹æƒ…çŸ­æœŸå†…è¿˜æœ‰è½¬æœºå—ï¼Ÿ" style="width:100%;box-sizing:border-box;padding:14px 16px;border-radius:12px;border:1px solid #e8e8ed;font-size:15px;min-height:72px;"></textarea>
                <button class="btn-submit" style="margin-top:8px;padding:10px 12px;font-size:14px;" onclick="runQimenFollowChat()">
                    <span>ğŸ’¬</span> ç»§ç»­è¯·æ•™ AI å®—å¸ˆ
                </button>
                <div id="followAnswer" style="display:none;margin-top:16px;padding:16px 20px;background:#f0f9ff;border-radius:14px;font-size:15px;color:#334155;border:1px dashed rgba(14,165,233,0.35);"></div>
            </div>
        </div>
    </div>

    <!-- è‚¡å¸‚é¢„æµ‹æ¿å— -->
    <div id="stockSection" style="display:none;">
        <div class="control-card" style="margin-top: 4px;">
            <div class="stock-section-header">ğŸ“Š è‚¡å¸‚é¢„æµ‹å®éªŒå®¤ Â· ç¤ºä¾‹åŠŸèƒ½ï¼Œä»…ä¾›ä½“éªŒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®</div>
            <div class="form-group">
                <label>å¸‚åœºä¸è‚¡ç¥¨ä»£ç </label>
                <div class="flex-row">
                    <select id="stockMarket" class="flex-1">
                        <option value="A">Aè‚¡</option>
                        <option value="US">ç¾è‚¡</option>
                    </select>
                    <input class="flex-1" id="stockSymbol" placeholder="ä¾‹å¦‚ï¼š600519 / 000001 / AAPL">
                </div>
            </div>
            <div class="form-group">
                <label>é¢„æµ‹å‘¨æœŸ</label>
                <select id="stockHorizon">
                    <option value="day">å½“æ—¥ / æ¬¡æ—¥ç›˜ä½</option>
                    <option value="week">æœªæ¥ä¸€å‘¨åŒºé—´</option>
                    <option value="month">æœªæ¥ä¸€æœˆå¤§è‡´åŒºé—´</option>
                </select>
            </div>
            <div class="form-group">
                <label>K çº¿æ—¶é—´èŒƒå›´</label>
                <select id="stockRange">
                    <option value="1h">è¿‘ 1 å°æ—¶</option>
                    <option value="3h">è¿‘ 3 å°æ—¶</option>
                    <option value="1d" selected>è¿‘ 1 å¤©</option>
                    <option value="6m">è¿‘åŠå¹´</option>
                    <option value="1y">è¿‘ä¸€å¹´</option>
                </select>
            </div>
            <button class="btn-submit" onclick="runStockPredict()">
                <span>ğŸ“ˆ</span> è‚¡å¸‚ç›˜ä½é¢„æµ‹ï¼ˆç¤ºä¾‹ï¼‰
            </button>
            <div id="stockResult" class="stock-result-card" style="display:none;"></div>
            <div id="stockChart" class="stock-chart-wrapper" style="display:none;">
                <div class="stock-chart-header">ğŸ“‰ K çº¿èµ°åŠ¿ï¼ˆä½¿ç”¨å¥‡é—¨+AI è§£è¯»åæ˜¾ç¤ºï¼‰</div>
                <div class="stock-chart-body" id="stockChartCanvas"></div>
            </div>
            <div id="stockAiExplain" class="stock-ai-box" style="display:none;"></div>
            <div class="form-group" style="margin-top:12px;">
                <label>åˆ†ææ·±åº¦</label>
                <div class="analysis-mode-row">
                    <label class="mode-opt"><input type="radio" name="stockMode" value="brief" checked> ç®€è¦ï¼ˆå…è´¹ï¼‰</label>
                    <label class="mode-opt"><input type="radio" name="stockMode" value="detail"> è¯¦ç»†ï¼ˆä»˜è´¹ï¼‰</label>
                </div>
            </div>
            <button class="btn-submit" style="margin-top:12px;background:linear-gradient(135deg,#0369a1 0%,#0c4a6e 100%);box-shadow:0 6px 20px rgba(2,132,199,0.4);" onclick="runStockQimenAI()">
                <span>â˜¯ï¸</span> å¥‡é—¨ + AI è§£è¯»å½“å‰è‚¡ç¥¨
            </button>
        </div>
    </div>

    <!-- ä»˜è´¹è§£é”å¼¹çª—ï¼šæ‰«ç æ”¯ä»˜ï¼Œåˆ°è´¦åå®¢æœå‘é€è§£é”ç  -->
    <div id="payModal" class="pay-modal" style="display:none;">
        <div class="pay-modal-content">
            <div class="pay-modal-title">ğŸ“± è¯¦ç»†åˆ†æéœ€ä»˜è´¹</div>
            <p class="pay-modal-desc">æ”¯ä»˜ <strong class="pay-amount">29.9 å…ƒ</strong> åï¼Œå³å¯ä½¿ç”¨è¯¦ç»†åˆ†æï¼ˆå«å¥‡é—¨é—®äº‹ä¸è‚¡å¸‚è§£è¯»ï¼‰ã€‚</p>
            <div class="pay-modal-qr-wrap">
                <img src="images/wechat-pay-qr.png" alt="å¾®ä¿¡æ”¯ä»˜" class="pay-modal-qr" onerror="this.style.display='none'; var p=this.nextElementSibling; if(p) p.style.display='block';">
                <div class="pay-modal-qr-placeholder" style="display:none;">è¯·å°†å¾®ä¿¡æ”¯ä»˜äºŒç»´ç ä¿å­˜ä¸º<br><code>qimen-web/public/images/wechat-pay-qr.png</code><br>åˆ·æ–°é¡µé¢åå³å¯æ˜¾ç¤º</div>
            </div>
            <p class="pay-modal-account">æ”¶æ¬¾ï¼šé£å½±å¦‚æ—§(ä¹‹) Â· æ¨èä½¿ç”¨å¾®ä¿¡æ”¯ä»˜</p>
            <p class="pay-modal-code-hint" style="margin:10px 0 6px 0; color:#666; font-size:0.9em;">ä»˜æ¬¾åˆ°è´¦åï¼Œå®¢æœä¼šå‘é€è§£é”ç ç»™æ‚¨ï¼Œè¯·åœ¨ä¸‹æ¡†è¾“å…¥åç‚¹å‡»è§£é”ã€‚</p>
            <div class="pay-modal-input-wrap">
                <input type="text" id="unlockCodeInput" placeholder="è¯·è¾“å…¥ä»˜æ¬¾åˆ°è´¦åå®¢æœå‘ŠçŸ¥çš„è§£é”ç " class="pay-modal-input">
                <button type="button" class="pay-modal-btn" onclick="doUnlock()">è§£é”</button>
            </div>
            <p id="unlockMsg" class="pay-modal-msg"></p>
            <button type="button" class="pay-modal-close" onclick="closePayModal()">å…³é—­</button>
        </div>
    </div>
</div>

<script>
// API å¿…é¡»é€šè¿‡åŒä¸€å° Node æœåŠ¡è®¿é—®ï¼Œä¸èƒ½ç›´æ¥åŒå‡»æ‰“å¼€ htmlï¼ˆfile://ï¼‰
var API_BASE = window.location.origin;
var PAY_TOKEN_KEY = 'qimen_paid_token';

function sanitizeApiKey(val) {
  var s = (val || '').trim();
  var i = s.indexOf('sk-');
  if (i !== -1) s = s.slice(i);
  return s.replace(/[/\s].*$/g, '').trim();
}

function getStoredPaidToken() {
  try { return localStorage.getItem(PAY_TOKEN_KEY) || null; } catch(e) { return null; }
}
function setStoredPaidToken(t) {
  try { if (t) localStorage.setItem(PAY_TOKEN_KEY, t); else localStorage.removeItem(PAY_TOKEN_KEY); } catch(e) {}
}

function showPayModal() {
  var el = document.getElementById('payModal');
  if (el) {
    el.style.display = 'flex';
    document.getElementById('unlockCodeInput').value = '';
    document.getElementById('unlockMsg').textContent = '';
  }
}
function closePayModal() {
  var el = document.getElementById('payModal');
  if (el) el.style.display = 'none';
}
function doUnlock() {
  var code = (document.getElementById('unlockCodeInput').value || '').trim();
  var msgEl = document.getElementById('unlockMsg');
  if (!code) { msgEl.textContent = 'è¯·è¾“å…¥è§£é”ç '; msgEl.className = 'pay-modal-msg err'; return; }
  if (window.location.protocol === 'file:') {
    msgEl.textContent = 'è¯·é€šè¿‡ http://localhost:3001 æ‰“å¼€é¡µé¢åå†è§£é”'; msgEl.className = 'pay-modal-msg err';
    return;
  }
  msgEl.textContent = 'éªŒè¯ä¸­...'; msgEl.className = 'pay-modal-msg';
  fetch(API_BASE + '/api/unlock', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ code: code })
  }).then(function(r) {
    return r.text().then(function(text) {
      var data = {};
      try { data = text ? JSON.parse(text) : {}; } catch(e) {}
      if (r.ok && data.token) {
        setStoredPaidToken(data.token);
        msgEl.textContent = 'è§£é”æˆåŠŸï¼Œå¯ä½¿ç”¨è¯¦ç»†åˆ†æ'; msgEl.className = 'pay-modal-msg ok';
        setTimeout(function() { closePayModal(); }, 1200);
      } else {
        msgEl.textContent = data.error || ('è¯·æ±‚å¼‚å¸¸ ' + r.status); msgEl.className = 'pay-modal-msg err';
      }
    });
  }).catch(function(err) {
    msgEl.textContent = 'æ— æ³•è¿æ¥æœåŠ¡å™¨ï¼Œè¯·ç¡®è®¤å·²è¿è¡Œ npm start å¹¶è®¿é—® http://localhost:' + (window.location.port || '3001'); msgEl.className = 'pay-modal-msg err';
  });
}

if (window.location.protocol === 'file:') {
    (function() {
        var tip = document.createElement('div');
        tip.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;background:#dc2626;color:#fff;padding:16px 24px;text-align:center;font-size:15px;font-weight:500;';
        tip.innerHTML = 'âš ï¸ å½“å‰ä¸ºæœ¬åœ°æ–‡ä»¶æ‰“å¼€ï¼ŒAPI æ— æ³•è°ƒç”¨ã€‚è¯·å…ˆåœ¨é¡¹ç›®ç›®å½•è¿è¡Œ <code>npm start</code> æˆ– <code>node server.js</code>ï¼Œå†åœ¨æµè§ˆå™¨è®¿é—® <strong>http://localhost:3001</strong>';
        document.body.insertBefore(tip, document.body.firstChild);
    })();
}

// --- åŸå¸‚ç»çº¬åº¦æ•°æ®ï¼ˆä¸åŸç‰ˆä¸€è‡´ï¼‰ ---
const CITY_DATA = {
    "åŒ—äº¬": [["åŒ—äº¬",116.40]], "å¤©æ´¥": [["å¤©æ´¥",117.20]], "ä¸Šæµ·": [["ä¸Šæµ·",121.47]], "é‡åº†": [["é‡åº†",106.55]],
    "æ²³åŒ—": [["çŸ³å®¶åº„",114.51],["å”å±±",118.18],["ç§¦çš‡å²›",119.60],["é‚¯éƒ¸",114.49],["é‚¢å°",114.50],["ä¿å®š",115.47],["å¼ å®¶å£",114.88],["æ‰¿å¾·",117.96],["æ²§å·",116.85],["å»ŠåŠ",116.68],["è¡¡æ°´",115.67],["é›„å®‰",116.0]],
    "å±±è¥¿": [["å¤ªåŸ",112.55],["å¤§åŒ",113.30],["é˜³æ³‰",113.58],["é•¿æ²»",113.11],["æ™‹åŸ",112.85],["æœ”å·",112.43],["æ™‹ä¸­",112.75],["è¿åŸ",111.00],["å¿»å·",112.73],["ä¸´æ±¾",111.51],["å•æ¢",111.14]],
    "å†…è’™å¤": [["å‘¼å’Œæµ©ç‰¹",111.74],["åŒ…å¤´",109.84],["ä¹Œæµ·",106.83],["èµ¤å³°",118.96],["é€šè¾½",122.25],["é„‚å°”å¤šæ–¯",109.78],["å‘¼ä¼¦è´å°”",119.76],["å·´å½¦æ·–å°”",107.39],["ä¹Œå…°å¯Ÿå¸ƒ",113.13],["å…´å®‰ç›Ÿ",122.05],["é”¡æ—éƒ­å‹’",116.07],["é˜¿æ‹‰å–„",105.72]],
    "è¾½å®": [["æ²ˆé˜³",123.43],["å¤§è¿",121.61],["éå±±",122.99],["æŠšé¡º",123.94],["æœ¬æºª",123.76],["ä¸¹ä¸œ",124.35],["é”¦å·",121.12],["è¥å£",122.23],["é˜œæ–°",121.67],["è¾½é˜³",123.17],["ç›˜é”¦",122.07],["é“å²­",123.83],["æœé˜³",120.45],["è‘«èŠ¦å²›",120.83]],
    "å‰æ—": [["é•¿æ˜¥",125.32],["å‰æ—",126.54],["å››å¹³",124.35],["è¾½æº",125.13],["é€šåŒ–",125.93],["ç™½å±±",126.42],["æ¾åŸ",124.82],["ç™½åŸ",122.83],["å»¶è¾¹",129.50]],
    "é»‘é¾™æ±Ÿ": [["å“ˆå°”æ»¨",126.66],["é½é½å“ˆå°”",123.96],["é¸¡è¥¿",130.96],["é¹¤å²—",130.29],["åŒé¸­å±±",131.15],["å¤§åº†",125.10],["ä¼Šæ˜¥",128.89],["ä½³æœ¨æ–¯",130.31],["ä¸ƒå°æ²³",131.00],["ç‰¡ä¸¹æ±Ÿ",129.63],["é»‘æ²³",127.52],["ç»¥åŒ–",126.96],["å¤§å…´å®‰å²­",124.71]],
    "æ±Ÿè‹": [["å—äº¬",118.79],["æ— é”¡",120.31],["å¾å·",117.28],["å¸¸å·",119.97],["è‹å·",120.58],["å—é€š",120.89],["è¿äº‘æ¸¯",119.22],["æ·®å®‰",119.01],["ç›åŸ",120.16],["æ‰¬å·",119.41],["é•‡æ±Ÿ",119.45],["æ³°å·",119.92],["å®¿è¿",118.27]],
    "æµ™æ±Ÿ": [["æ­å·",120.15],["å®æ³¢",121.55],["æ¸©å·",120.69],["å˜‰å…´",120.75],["æ¹–å·",120.08],["ç»å…´",120.58],["é‡‘å",119.64],["è¡¢å·",118.85],["èˆŸå±±",122.20],["å°å·",121.42],["ä¸½æ°´",119.92]],
    "å®‰å¾½": [["åˆè‚¥",117.22],["èŠœæ¹–",118.37],["èšŒåŸ ",117.38],["æ·®å—",116.99],["é©¬éå±±",118.50],["æ·®åŒ—",116.79],["é“œé™µ",117.81],["å®‰åº†",117.02],["é»„å±±",118.33],["æ»å·",118.31],["é˜œé˜³",115.81],["å®¿å·",116.98],["å…­å®‰",116.53],["äº³å·",115.77],["æ± å·",117.49],["å®£åŸ",118.75]],
    "ç¦å»º": [["ç¦å·",119.29],["å¦é—¨",118.08],["è†ç”°",119.00],["ä¸‰æ˜",117.63],["æ³‰å·",118.67],["æ¼³å·",117.64],["å—å¹³",118.17],["é¾™å²©",117.02],["å®å¾·",119.54]],
    "æ±Ÿè¥¿": [["å—æ˜Œ",115.85],["æ™¯å¾·é•‡",117.17],["èä¹¡",113.84],["ä¹æ±Ÿ",116.00],["æ–°ä½™",114.91],["é¹°æ½­",117.06],["èµ£å·",114.93],["å‰å®‰",114.99],["å®œæ˜¥",114.41],["æŠšå·",116.35],["ä¸Šé¥¶",117.94]],
    "å±±ä¸œ": [["æµå—",117.12],["é’å²›",120.38],["æ·„åš",118.05],["æ£åº„",117.32],["ä¸œè¥",118.67],["çƒŸå°",121.44],["æ½åŠ",119.16],["æµå®",116.58],["æ³°å®‰",117.08],["å¨æµ·",122.12],["æ—¥ç…§",119.52],["ä¸´æ²‚",118.35],["å¾·å·",116.35],["èŠåŸ",115.98],["æ»¨å·",117.97],["èæ³½",115.48]],
    "æ²³å—": [["éƒ‘å·",113.62],["å¼€å°",114.30],["æ´›é˜³",112.45],["å¹³é¡¶å±±",113.19],["å®‰é˜³",114.39],["é¹¤å£",114.29],["æ–°ä¹¡",113.92],["ç„¦ä½œ",113.24],["æ¿®é˜³",115.02],["è®¸æ˜Œ",113.85],["æ¼¯æ²³",114.01],["ä¸‰é—¨å³¡",111.20],["å—é˜³",112.52],["å•†ä¸˜",115.65],["ä¿¡é˜³",114.09],["å‘¨å£",114.69],["é©»é©¬åº—",114.02]],
    "æ¹–åŒ—": [["æ­¦æ±‰",114.30],["é»„çŸ³",115.03],["åå °",110.79],["å®œæ˜Œ",111.28],["è¥„é˜³",112.12],["é„‚å·",114.89],["è†é—¨",112.19],["å­æ„Ÿ",113.95],["è†å·",112.23],["é»„å†ˆ",114.87],["å’¸å®",114.32],["éšå·",113.38],["æ©æ–½",109.48]],
    "æ¹–å—": [["é•¿æ²™",112.93],["æ ªæ´²",113.13],["æ¹˜æ½­",112.94],["è¡¡é˜³",112.57],["é‚µé˜³",111.46],["å²³é˜³",113.12],["å¸¸å¾·",111.69],["å¼ å®¶ç•Œ",110.47],["ç›Šé˜³",112.35],["éƒ´å·",113.01],["æ°¸å·",111.61],["æ€€åŒ–",109.99],["å¨„åº•",112.00],["æ¹˜è¥¿",109.72]],
    "å¹¿ä¸œ": [["å¹¿å·",113.26],["éŸ¶å…³",113.59],["æ·±åœ³",114.05],["ç æµ·",113.57],["æ±•å¤´",116.68],["ä½›å±±",113.12],["æ±Ÿé—¨",113.08],["æ¹›æ±Ÿ",110.35],["èŒ‚å",110.92],["è‚‡åº†",112.46],["æƒ å·",114.41],["æ¢…å·",116.12],["æ±•å°¾",115.37],["æ²³æº",114.70],["é˜³æ±Ÿ",111.98],["æ¸…è¿œ",113.05],["ä¸œè",113.75],["ä¸­å±±",113.39],["æ½®å·",116.62],["æ­é˜³",116.37],["äº‘æµ®",112.04]],
    "å¹¿è¥¿": [["å—å®",108.36],["æŸ³å·",109.41],["æ¡‚æ—",110.29],["æ¢§å·",111.27],["åŒ—æµ·",109.11],["é˜²åŸæ¸¯",108.35],["é’¦å·",108.65],["è´µæ¸¯",109.59],["ç‰æ—",110.18],["ç™¾è‰²",106.61],["è´ºå·",111.56],["æ²³æ± ",108.08],["æ¥å®¾",109.22],["å´‡å·¦",107.36]],
    "æµ·å—": [["æµ·å£",110.32],["ä¸‰äºš",109.51],["ä¸‰æ²™",112.33],["å„‹å·",109.57]],
    "å››å·": [["æˆéƒ½",104.06],["è‡ªè´¡",104.77],["æ”€æèŠ±",101.71],["æ³¸å·",105.44],["å¾·é˜³",104.39],["ç»µé˜³",104.73],["å¹¿å…ƒ",105.84],["é‚å®",105.59],["å†…æ±Ÿ",105.05],["ä¹å±±",103.76],["å—å……",106.08],["çœ‰å±±",103.84],["å®œå®¾",104.64],["å¹¿å®‰",106.63],["è¾¾å·",107.50],["é›…å®‰",103.04],["å·´ä¸­",106.75],["èµ„é˜³",104.62],["é˜¿å",102.22],["ç”˜å­œ",101.96],["å‡‰å±±",102.26]],
    "è´µå·": [["è´µé˜³",106.63],["å…­ç›˜æ°´",104.83],["éµä¹‰",106.92],["å®‰é¡º",105.94],["æ¯•èŠ‚",105.29],["é“œä»",109.18],["é»”è¥¿å—",104.89],["é»”ä¸œå—",107.98],["é»”å—",107.51]],
    "äº‘å—": [["æ˜†æ˜",102.83],["æ›²é–",103.79],["ç‰æºª",102.54],["ä¿å±±",99.16],["æ˜­é€š",103.71],["ä¸½æ±Ÿ",100.23],["æ™®æ´±",100.97],["ä¸´æ²§",100.08],["æ¥šé›„",101.54],["çº¢æ²³",103.37],["æ–‡å±±",104.21],["è¥¿åŒç‰ˆçº³",100.79],["å¤§ç†",100.22],["å¾·å®",98.57],["æ€’æ±Ÿ",98.85],["è¿ªåº†",99.70]],
    "è¥¿è—": [["æ‹‰è¨",91.14],["æ—¥å–€åˆ™",88.88],["æ˜Œéƒ½",97.17],["æ—èŠ",94.36],["å±±å—",91.77],["é‚£æ›²",92.05],["é˜¿é‡Œ",80.10]],
    "é™•è¥¿": [["è¥¿å®‰",108.93],["é“œå·",109.07],["å®é¸¡",107.23],["å’¸é˜³",108.70],["æ¸­å—",109.50],["å»¶å®‰",109.48],["æ±‰ä¸­",107.02],["æ¦†æ—",109.73],["å®‰åº·",109.02],["å•†æ´›",109.94]],
    "ç”˜è‚ƒ": [["å…°å·",103.83],["å˜‰å³ªå…³",98.28],["é‡‘æ˜Œ",102.18],["ç™½é“¶",104.13],["å¤©æ°´",105.71],["æ­¦å¨",102.63],["å¼ æ–",100.45],["å¹³å‡‰",106.66],["é…’æ³‰",98.49],["åº†é˜³",107.63],["å®šè¥¿",104.62],["é™‡å—",104.92],["ä¸´å¤",103.21],["ç”˜å—",102.91]],
    "é’æµ·": [["è¥¿å®",101.77],["æµ·ä¸œ",102.10],["æµ·åŒ—",100.90],["é»„å—",102.01],["æµ·å—",100.61],["æœæ´›",100.24],["ç‰æ ‘",97.00],["æµ·è¥¿",97.37]],
    "å®å¤": [["é“¶å·",106.23],["çŸ³å˜´å±±",106.38],["å´å¿ ",106.19],["å›ºåŸ",106.24],["ä¸­å«",105.18]],
    "æ–°ç–†": [["ä¹Œé²æœ¨é½",87.61],["å…‹æ‹‰ç›ä¾",84.88],["åé²ç•ª",89.18],["å“ˆå¯†",93.51],["æ˜Œå‰",87.30],["åšå°”å¡”æ‹‰",82.06],["å·´éŸ³éƒ­æ¥",86.14],["é˜¿å…‹è‹",80.26],["å…‹å­œå‹’è‹",76.16],["å–€ä»€",75.98],["å’Œç”°",79.92],["ä¼ŠçŠ",81.32],["å¡”åŸ",82.98],["é˜¿å‹’æ³°",88.13]],
    "é¦™æ¸¯": [["é¦™æ¸¯",114.16]], "æ¾³é—¨": [["æ¾³é—¨",113.54]], "å°æ¹¾": [["å°åŒ—",121.50],["é«˜é›„",120.30]]
};

const pSel = document.getElementById('provinceSel');
const cSel = document.getElementById('citySel');
Object.keys(CITY_DATA).forEach(p => pSel.add(new Option(p, p)));
pSel.onchange = function() {
    cSel.innerHTML = '';
    CITY_DATA[this.value].forEach(c => {
        let opt = new Option(c[0], c[1]);
        if(c[0] === 'åŒ—äº¬' || c[0] === this.value) opt.selected = true;
        cSel.add(opt);
    });
};
pSel.value = 'åŒ—äº¬'; pSel.onchange();

const QM = {
    GUA: {1:'å',2:'å¤',3:'éœ‡',4:'å·½',5:'ä¸­',6:'ä¹¾',7:'å…‘',8:'è‰®',9:'ç¦»'},
    YANG_JU: { 'å†¬è‡³':[1,7,4], 'æƒŠè›°':[1,7,4], 'å°å¯’':[2,8,5], 'å¤§å¯’':[3,9,6], 'æ˜¥åˆ†':[3,9,6], 'é›¨æ°´':[9,6,3], 'æ¸…æ˜':[4,1,7], 'ç«‹å¤':[4,1,7], 'ç«‹æ˜¥':[8,5,2], 'è°·é›¨':[5,2,8], 'å°æ»¡':[5,2,8], 'èŠ’ç§':[6,3,9] },
    YIN_JU: { 'å¤è‡³':[9,3,6], 'ç™½éœ²':[9,3,6], 'å°æš‘':[8,2,5], 'å¤§æš‘':[7,1,4], 'ç§‹åˆ†':[7,1,4], 'ç«‹ç§‹':[2,5,8], 'å¯’éœ²':[6,9,3], 'ç«‹å†¬':[6,9,3], 'å¤„æš‘':[1,4,7], 'éœœé™':[5,8,2], 'å°é›ª':[5,8,2], 'å¤§é›ª':[4,7,1] },
    STAR: ['','å¤©è“¬','å¤©èŠ®','å¤©å†²','å¤©è¾…','å¤©ç¦½','å¤©å¿ƒ','å¤©æŸ±','å¤©ä»»','å¤©è‹±'],
    DOOR: {1:'ä¼‘',2:'æ­»',3:'ä¼¤',4:'æœ',6:'å¼€',7:'æƒŠ',8:'ç”Ÿ',9:'æ™¯'}, 
    PATH: [1,8,3,4,9,2,7,6], STEMS: 'ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸', ZHI: 'å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥',
    
    getWx: function(n) {
        if('ç”²ä¹™å¯…å¯ä¼¤æœå¤©å†²å¤©è¾…'.includes(n)) return 'wx-wood';
        if('ä¸™ä¸å·³åˆæ™¯å¤©è‹±è…¾è›‡æœ±é›€'.includes(n)) return 'wx-fire';
        if('æˆŠå·±è¾°æˆŒä¸‘æœªæ­»ç”Ÿå¤©ä»»å¤©èŠ®å¤©ç¦½å€¼ç¬¦å‹¾é™ˆä¹åœ°'.includes(n)) return 'wx-earth';
        if('åºšè¾›ç”³é…‰æƒŠå¼€å¤©æŸ±å¤©å¿ƒå¤©è“¬ä¹å¤©ç™½è™å¤ªé˜´'.includes(n)) return 'wx-metal';
        if('ä¼‘å£¬ç™¸äº¥å­ç„æ­¦'.includes(n)) return 'wx-water';
        return '';
    },

    calc: function(dateStr) {
        let d = new Date(dateStr), lunar = Lunar.fromDate(d), bazi = lunar.getBaZi();
        let jq = lunar.getPrevJieQi(true).getName().replace(/[èŠ‚æ°”]/g,'');
        
        let dGZ = bazi[2], tGZ = bazi[3];
        let dGIdx = this.STEMS.indexOf(dGZ[0]), dZIdx = this.ZHI.indexOf(dGZ[1]);
        let yuan = Math.floor(((dGIdx*6 - dZIdx*5 + 60)%60)/5)%3;
        let isYang = !!this.YANG_JU[jq], ju = (isYang ? this.YANG_JU : this.YIN_JU)[jq][yuan] || 1;

        let stems = ['æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸','ä¸','ä¸™','ä¹™'];
        let earth = {}; let p = ju;
        for(let i=0; i<9; i++) { earth[p] = stems[i]; p = isYang ? (p%9)+1 : (p-1)||9; }

        let hG = tGZ[0], hZ = tGZ[1];
        let xunDiff = (this.ZHI.indexOf(hZ) - this.STEMS.indexOf(hG) + 12) % 12;
        let leadStem = {0:'æˆŠ',10:'å·±',8:'åºš',6:'è¾›',4:'å£¬',2:'ç™¸'}[xunDiff];
        let xunZhi = {0:'å­',10:'æˆŒ',8:'ç”³',6:'åˆ',4:'è¾°',2:'å¯…'}[xunDiff];
        
        let leadP = 0; for(let k in earth) if(earth[k]===leadStem) leadP=+k;
        let zhifu = (leadP===5) ? 'å¤©ç¦½' : this.STAR[leadP];
        let zhishi = (leadP===5) ? 'æ­»' : (this.DOOR[leadP]||'æ­»');

        let hourStemLoc = 0, search = (hG==='ç”²')?leadStem:hG;
        for(let k in earth) if(earth[k]===search) hourStemLoc=+k;
        let zfLand = (hourStemLoc===5)?2:hourStemLoc;
        
        let startP = (leadP===5)?2:leadP;
        let sIdx = this.PATH.indexOf(startP), eIdx = this.PATH.indexOf(zfLand);
        let shift = (eIdx - sIdx + 8) % 8;
        
        let grid = {}; for(let i=1; i<=9; i++) grid[i] = { id:i, earth:earth[i] };
        
        for(let i=0; i<8; i++) {
            let curr = this.PATH[i], src = this.PATH[(i - shift + 8)%8];
            let star = (src===2)?'å¤©èŠ®':this.STAR[src], sky = earth[src];
            if(src===2) { sky = earth[5]+(earth[2]||''); grid[curr].hasQin=true; }
            grid[curr].star = star; grid[curr].sky = sky;
        }
        grid[5].sky = '';

        let step = (this.ZHI.indexOf(hZ) - this.ZHI.indexOf(xunZhi) + 12) % 12;
        let zsLand = leadP;
        if(isYang) { zsLand += step; while(zsLand>9) zsLand-=9; } else { zsLand -= step; while(zsLand<1) zsLand+=9; }
        if(zsLand===5) zsLand=2;
        
        let doors = ['ä¼‘','ç”Ÿ','ä¼¤','æœ','æ™¯','æ­»','æƒŠ','å¼€'], dStart = doors.indexOf(zhishi);
        let tIdx = this.PATH.indexOf(zsLand);
        for(let i=0; i<8; i++) grid[this.PATH[(tIdx+i)%8]].door = doors[(dStart+i)%8];
        
        let gods = ['å€¼ç¬¦','è…¾è›‡','å¤ªé˜´','å…­åˆ','ç™½è™','ç„æ­¦','ä¹åœ°','ä¹å¤©'], gStart = this.PATH.indexOf(zfLand);
        for(let i=0; i<8; i++) {
            let idx = isYang ? (gStart+i)%8 : (gStart-i+8)%8;
            grid[this.PATH[idx]].god = gods[i];
        }

        let maMap = {'ç”³':'å¯…','å­':'å¯…','è¾°':'å¯…','å¯…':'ç”³','åˆ':'ç”³','æˆŒ':'ç”³','äº¥':'å·³','å¯':'å·³','æœª':'å·³','å·³':'äº¥','é…‰':'äº¥','ä¸‘':'äº¥'};
        let maP = {'å¯…':8,'ç”³':2,'äº¥':6,'å·³':4}[maMap[hZ]]||0;
        let kongP = [];
        if(xunDiff===0) kongP=[6]; if(xunDiff===10) kongP=[2,7]; if(xunDiff===8) kongP=[9,2];
        if(xunDiff===6) kongP=[4]; if(xunDiff===4) kongP=[8,3]; if(xunDiff===2) kongP=[1,8];

        return {
            dateStr: dateStr.replace('T',' '), bazi: bazi.join(' '),
            info: `${jq} ${['ä¸Š','ä¸­','ä¸‹'][yuan]}å…ƒ ${isYang?'é˜³':'é˜´'}${ju}å±€`,
            xun: `ç”²${xunZhi}${leadStem}`, zhifu, zhishi, grid, maP, kongP
        };
    }
};

function setDefaultTime() {
    let now = new Date(); let pad = n=>n<10?'0'+n:n;
    document.getElementById('askTime').value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
}

async function runSystem() {
    let question = document.getElementById('userQuestion').value;
    let t = document.getElementById('askTime').value;
    if(!t) { alert('è¯·é€‰æ‹©é—®äº‹æ—¶é—´'); return; }
    
    let lng = parseFloat(document.getElementById('citySel').value) || 120;
    let d = new Date(t), diff = (lng - 120) * 4;
    d.setMinutes(d.getMinutes() + diff);
    let pad = n=>n<10?'0'+n:n;
    let solarT = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    
    let data = QM.calc(solarT);
    // è®°å½•æœ€è¿‘ä¸€æ¬¡ç›˜é¢ï¼Œä¾›â€œå¥‡é—¨ + è‚¡å¸‚ AI è§£è¯»â€ä½¿ç”¨
    window._lastPanData = data;
    
    document.getElementById('panArea').style.display = 'block';
    document.getElementById('dateInfo').innerText = data.dateStr;
    document.getElementById('baziInfo').innerText = data.bazi;
    document.getElementById('jieqiInfo').innerText = data.info;
    document.getElementById('xunInfo').innerText = "æ—¬é¦–ï¼š" + data.xun;
    document.getElementById('zhifuInfo').innerText = `å€¼ç¬¦[${data.zhifu}] å€¼ä½¿[${data.zhishi}]`;
    document.getElementById('solarNote').innerText = `* å·²æ ¡å‡†çœŸå¤ªé˜³æ—¶ (${lng}Â° ${diff>0?'+':''}${Math.round(diff)}åˆ†)`;
    
    let bt = document.getElementById('birthTime').value;
    if(bt) {
        document.getElementById('birthRow').style.display = 'block';
        let bd = new Date(bt); bd.setMinutes(bd.getMinutes() + diff);
        document.getElementById('birthInfo').innerText = Lunar.fromDate(bd).getBaZi().join(' ');
    } else {
        document.getElementById('birthRow').style.display = 'none';
    }

    let el = document.getElementById('grid'); el.innerHTML = '';
    [4,9,2, 3,5,7, 8,1,6].forEach(id => {
        let cell = document.createElement('div'), g = data.grid[id];
        
        if(id===5) {
            cell.className = 'center-cell';
            cell.innerHTML = `<div style="font-size:0.8em;color:#999;margin-bottom:4px;">ä¸­äº”</div><div class="stem-char wx-earth">${g.earth}</div>`;
        } else {
            cell.className = 'cell';
            let leftCol = `<div class="cell-left"><span class="font-gua">${QM.GUA[id]}</span></div>`;
            let starHtml = g.hasQin ? `<span class="font-star wx-earth">å¤©ç¦½</span>` : `<span class="font-star ${QM.getWx(g.star)}">${g.star}</span>`;
            let midCol = `<div class="cell-mid"><span class="font-god ${QM.getWx(g.god)}">${g.god}</span>${starHtml}<span class="font-door ${QM.getWx(g.door)}">${g.door}é—¨</span></div>`;
            let skyHtml = '';
            if(g.sky) { let stems = g.sky.split(''); skyHtml = stems.map(s => `<span class="stem-char ${QM.getWx(s)}">${s}</span>`).join(''); }
            let rightCol = `<div class="cell-right"><div class="sky-group">${skyHtml}</div><div class="stem-char ${QM.getWx(g.earth)}">${g.earth}</div></div>`;
            
            let marks = '';
            if(data.maP===id) marks += '<div class="mark-ma">é©¬</div>';
            if(data.kongP.includes(id)) marks += '<div class="mark-kong">ç©º</div>';
            
            cell.innerHTML = leftCol + midCol + rightCol + marks;
            if(data.zhishi === g.door) cell.style.backgroundColor = 'rgba(255,0,0,0.03)';
        }
        el.appendChild(cell);
    });

    var mode = (document.querySelector('input[name="qimenMode"]:checked') || {}).value || 'brief';
    if (mode === 'brief' && document.getElementById('apiKey').value) {
        await doAI(data, question);
    } else if (mode === 'detail') {
        if (document.getElementById('apiKey').value) await doAI(data, question);
        else document.getElementById('aiResult').style.display = 'none';
    } else {
        document.getElementById('aiResult').style.display = 'none';
    }
}

async function doAI(d, userQ) {
    var mode = (document.querySelector('input[name="qimenMode"]:checked') || {}).value || 'brief';
    if (mode === 'detail') {
        var token = getStoredPaidToken();
        if (!token) {
            showPayModal();
            return;
        }
    }
    let box = document.getElementById('aiResult');
    box.style.display = 'block';
    box.innerHTML = '<div class="ai-header">ğŸ¤– AI å¤§å¸ˆæ­£åœ¨å‡ç¥æ¨ç®—...</div>';

    try {
        const apiKey = sanitizeApiKey(document.getElementById('apiKey').value);
        var body = { panData: d, userQuestion: userQ, apiKey };
        if (mode === 'detail' && getStoredPaidToken()) body.paidToken = getStoredPaidToken();
        const res = await fetch(API_BASE + '/api/qimen/interpret', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if (!res.ok) {
            const text = await res.text();
            box.innerHTML = '<div class="ai-header">âŒ æœåŠ¡å™¨é”™è¯¯</div><div style="font-size:13px;color:#6b7280;">' + text + '</div>';
            return;
        }

        const json = await res.json();
        const content = json.content || '';
        var header = mode === 'brief' ? 'ğŸ“‹ ç®€è¦æ¨¡å¼ Â· çº¦300å­—åˆ†æï¼ˆä¸å«ç»“æœï¼‰' : 'ğŸ¤– AI å®—å¸ˆè§£è¯»';
        box.innerHTML = '<div class="ai-header">' + header + '</div>' + marked.parse(content);

        // é¦–æ¬¡è§£è¯»æˆåŠŸåï¼Œå±•ç¤ºè¿½é—®å¯¹è¯æ¡†ï¼ˆä»…è¯¦ç»†æ¨¡å¼æ˜¾ç¤ºï¼‰
        const chatCard = document.getElementById('aiChatCard');
        const followBox = document.getElementById('followAnswer');
        if (chatCard) {
            chatCard.style.display = 'block';
        }
        if (followBox) {
            followBox.style.display = 'none';
            followBox.innerHTML = '';
        }
    } catch(e) {
        box.innerHTML = '<div class="ai-header">âŒ è¿æ¥å¤±è´¥</div>è¯·æ£€æŸ¥æœåŠ¡å™¨æˆ–ç½‘ç»œè¿æ¥ã€‚';
    }
}

// å¥‡é—¨ AI è¿½é—®å¯¹è¯
async function runQimenFollowChat() {
    const q = (document.getElementById('followQuestion').value || '').trim();
    const apiKey = sanitizeApiKey(document.getElementById('apiKey').value);
    const box = document.getElementById('followAnswer');

    if (!window._lastPanData) {
        alert('è¯·å…ˆå®Œæˆä¸€æ¬¡æ’ç›˜ä¸åˆæ¬¡ AI è§£è¯»ï¼Œå†è¿›è¡Œè¿½é—®ã€‚');
        return;
    }
    if (!q) {
        alert('è¯·å…ˆè¾“å…¥è¦è¿½é—®çš„å…·ä½“é—®é¢˜ã€‚');
        return;
    }
    if (!apiKey) {
        alert('è¯·å…ˆåœ¨ä¸Šæ–¹å¡«å†™ DeepSeek API Keyã€‚');
        return;
    }

    box.style.display = 'block';
    box.innerHTML = 'ğŸ’¬ AI å®—å¸ˆæ­£åœ¨æ ¹æ®å½“å‰è¿™ç›˜ç»§ç»­æ¨æ¼”ï¼Œè¯·ç¨å€™...';

    try {
        var chatBody = { panData: window._lastPanData, followQuestion: q, apiKey };
        if (getStoredPaidToken()) chatBody.paidToken = getStoredPaidToken();
        const res = await fetch(API_BASE + '/api/qimen/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(chatBody)
        });

        if (!res.ok) {
            const text = await res.text();
            box.innerHTML = 'âŒ è¿½é—®æ¥å£æŠ¥é”™ï¼š<br><span style="font-size:12px;color:#6b7280;">' + text + '</span>';
            return;
        }

        const json = await res.json();
        const content = json.content || '';
        box.innerHTML = marked.parse(content);
    } catch (e) {
        box.innerHTML = 'âŒ æ— æ³•è¿æ¥å¥‡é—¨è¿½é—®æ¥å£ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æˆ–ç½‘ç»œæƒ…å†µã€‚';
    }
}

let stockChart;

function renderStockKline(kData, zone) {
    const wrapper = document.getElementById('stockChart');
    const canvasEl = document.getElementById('stockChartCanvas');
    if (!wrapper) return;
    wrapper.style.display = 'block';
    var dom = canvasEl || wrapper;

    // é˜²å¾¡ï¼šå¦‚æœ ECharts æ²¡åŠ è½½æˆåŠŸï¼Œç»™å‡ºæç¤º
    if (typeof echarts === 'undefined') {
        if (canvasEl) canvasEl.innerHTML = '<div style="padding:16px;font-size:14px;color:#b91c1c;">K çº¿å›¾ä¾èµ–çš„ ECharts èµ„æºæœªèƒ½åŠ è½½ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œæˆ– CDN è¢«æ‹¦æˆªï¼‰ï¼Œå½“å‰ä»…èƒ½æ˜¾ç¤ºæ–‡å­—é¢„æµ‹åŒºé—´ã€‚</div>';
        return;
    }
    if (!kData || !kData.candles || kData.candles.length === 0) {
        if (canvasEl) canvasEl.innerHTML = '<div style="padding:16px;font-size:14px;color:#64748b;">æš‚æ—  K çº¿æ•°æ®ï¼Œä»…æ˜¾ç¤ºä¸Šæ–¹æ–‡å­—è§£è¯»ã€‚</div>';
        return;
    }

    if (!stockChart) {
        stockChart = echarts.init(dom, null, { renderer: 'canvas' });
        window.addEventListener('resize', function() {
            try { if (stockChart) stockChart.resize(); } catch(e) {}
        });
    }
    const dates = kData.candles.map(c => c.date);
    const values = kData.candles.map(c => [c.open, c.close, c.low, c.high]);

    // åœ¨ç°æœ‰ K çº¿åé¢å¢åŠ â€œæœªæ¥å‡ æ—¥â€çš„æ¨¡æ‹Ÿ K çº¿ï¼ˆç®€å•éšæœºæ¸¸èµ°ï¼Œè®©è§†è§‰ä¸Šæœ‰æ¶¨è½ï¼‰
    let extendedDates = dates.slice();
    let extendedValues = values.slice();
    const last = kData.candles[kData.candles.length - 1];
    let lastClose = last ? last.close : 0;

    // ç®€å•ä¼ªéšæœºå‡½æ•°ï¼Œä¿è¯æ¯æ¬¡åˆ·æ–°å›¾å½¢æ—¶æœªæ¥ K çº¿ä¸ä¼šå…¨éƒ¨ä¸ºæ°´å¹³çº¿
    let seed = Date.now() % 100000;
    function frand(min, max) {
        seed = (seed * 1664525 + 1013904223) >>> 0;
        const r = seed / 0xffffffff;
        return min + (max - min) * r;
    }

    const futureLabels = ['é¢„ä¼°+1', 'é¢„ä¼°+2', 'é¢„ä¼°+3', 'é¢„ä¼°+4', 'é¢„ä¼°+5', 'é¢„ä¼°+6', 'é¢„ä¼°+7', 'é¢„ä¼°+8', 'é¢„ä¼°+9', 'é¢„ä¼°+10']; // æœªæ¥åæ—¥ç¤ºæ„
    const futureValues = [];
    futureLabels.forEach(() => {
        const changePct = frand(-0.025, 0.025); // çº¦ -2.5% ~ +2.5%
        const close = +(lastClose * (1 + changePct)).toFixed(2);
        const high = +(Math.max(close, lastClose) * (1 + frand(0, 0.01))).toFixed(2);
        const low = +(Math.min(close, lastClose) * (1 - frand(0, 0.01))).toFixed(2);
        const open = +(lastClose + (close - lastClose) * frand(0.2, 0.8)).toFixed(2);
        futureValues.push([open, close, low, high]);
        lastClose = close;
    });

    futureLabels.forEach((lab, idx) => {
        extendedDates.push(lab);
        extendedValues.push(futureValues[idx]);
    });

    const option = {
        grid: { left: 44, right: 20, top: 24, bottom: 36 },
        backgroundColor: 'transparent',
        xAxis: {
            type: 'category',
            data: extendedDates,
            boundaryGap: true,
            axisLine: { lineStyle: { color: 'rgba(14,165,233,0.25)' } },
            axisLabel: { color: '#64748b', fontSize: 11 },
            axisTick: { show: false }
        },
        yAxis: {
            scale: true,
            axisLine: { show: false },
            axisLabel: { color: '#64748b', fontSize: 11 },
            splitLine: { lineStyle: { color: 'rgba(14,165,233,0.12)', type: 'dashed' } }
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'cross' },
            backgroundColor: 'rgba(15,23,42,0.9)',
            borderColor: 'rgba(14,165,233,0.35)',
            textStyle: { color: '#f8fafc', fontSize: 12 }
        },
        series: [
            {
                type: 'candlestick',
                data: extendedValues,
                itemStyle: {
                    color: '#ef4444',
                    color0: '#22c55e',
                    borderColor: '#dc2626',
                    borderColor0: '#16a34a'
                },
                markLine: zone ? {
                    symbol: 'none',
                    lineStyle: { type: 'dashed', width: 1.2 },
                    data: [
                        {
                            yAxis: zone.basePoint,
                            lineStyle: { color: '#6366f1' },
                            label: { formatter: 'åŸºå‡†ç‚¹ä½', color: '#4f46e5', fontSize: 10 }
                        },
                        {
                            yAxis: zone.support,
                            lineStyle: { color: '#0ea5e9' },
                            label: { formatter: 'ä¸‹æ–¹å‚è€ƒåŒº', color: '#0369a1', fontSize: 10 }
                        },
                        {
                            yAxis: zone.resistance,
                            lineStyle: { color: '#f97316' },
                            label: { formatter: 'ä¸Šæ–¹å‚è€ƒåŒº', color: '#c2410c', fontSize: 10 }
                        }
                    ]
                } : undefined,
                // æ•´ä¸ªå›¾çš„èƒŒæ™¯ä¸åš markAreaï¼Œåªç”¨ä¸‹æ–¹å•ç‹¬çš„åŒºé—´å¸¦æ¥å¼ºè°ƒæœªæ¥éƒ¨åˆ†
            },
            zone ? {
                type: 'line',
                data: [],
                markArea: {
                    itemStyle: {
                        color: {
                            type: 'linear',
                            x: 0, y: 1, x2: 0, y2: 0,
                            colorStops: [
                                { offset: 0, color: 'rgba(249, 115, 22, 0.5)' },
                                { offset: 0.35, color: 'rgba(99, 102, 241, 0.35)' },
                                { offset: 0.65, color: 'rgba(59, 130, 246, 0.35)' },
                                { offset: 1, color: 'rgba(14, 165, 233, 0.5)' }
                            ]
                        },
                        borderColor: 'rgba(14, 165, 233, 0.5)',
                        borderWidth: 1.5
                    },
                    data: [[
                        {
                            xAxis: dates[dates.length - 1],
                            yAxis: zone.support
                        },
                        {
                            xAxis: extendedDates[extendedDates.length - 1],
                            yAxis: zone.resistance,
                            label: {
                                show: true,
                                position: 'insideTopRight',
                                formatter: 'æœªæ¥å‡ æ—¥æ¨¡æ‹ŸåŒºé—´',
                                color: '#0369a1',
                                fontSize: 10
                            }
                        }
                    ]]
                }
            } : null
        ].filter(Boolean)
    };

    stockChart.setOption(option);
    setTimeout(function() {
        try { if (stockChart) stockChart.resize(); } catch(e) {}
    }, 100);
}

function getKlinePointsByRange() {
    const sel = document.getElementById('stockRange');
    const range = sel ? sel.value : '1d';
    switch (range) {
        case '1h': return 20;   // è¿‘ 1 å°æ—¶ï¼šæ›´ç»†ä¸€äº›
        case '3h': return 40;   // è¿‘ 3 å°æ—¶
        case '6m': return 120;  // è¿‘åŠå¹´
        case '1y': return 120;  // è¿‘ä¸€å¹´ï¼ˆå—åç«¯ä¸Šé™å½±å“ï¼‰
        case '1d':
        default: return 60;     // è¿‘ 1 å¤©
    }
}

// è‚¡å¸‚é¢„æµ‹ï¼šè°ƒç”¨åç«¯ /api/stocks/predict + /api/stocks/kline
async function runStockPredict() {
    const market = document.getElementById('stockMarket').value;
    const symbol = (document.getElementById('stockSymbol').value || '').trim();
    const horizon = document.getElementById('stockHorizon').value;
    const box = document.getElementById('stockResult');
    const aiBox = document.getElementById('stockAiExplain');

    if (!symbol) {
        alert('è¯·å…ˆè¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œä¾‹å¦‚ 600519ã€000001 æˆ– AAPL');
        return;
    }

    box.style.display = 'block';
    aiBox.style.display = 'none';
    var chartWrap = document.getElementById('stockChart');
    if (chartWrap) chartWrap.style.display = 'none';
    box.innerHTML = 'â³ æ­£åœ¨æ ¹æ®ç›˜ä½ä¸æ³¢åŠ¨åŒºé—´è¿›è¡Œæ¨¡æ‹Ÿé¢„æµ‹ï¼Œè¯·ç¨å€™...';

    try {
        const res = await fetch(API_BASE + '/api/stocks/predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ symbol, market, horizon })
        });

        if (!res.ok) {
            const text = await res.text();
            box.innerHTML = 'âŒ æœåŠ¡å™¨è¿”å›é”™è¯¯ï¼š<br><span style="font-size:12px;color:#6b7280;">' + text + '</span>';
            return;
        }

        const data = await res.json();
        const marketName = data.market === 'US' ? 'ç¾è‚¡' : 'Aè‚¡';
        const hzText =
            data.horizon === 'week' ? 'æœªæ¥ä¸€å‘¨'
            : data.horizon === 'month' ? 'æœªæ¥ä¸€æœˆ'
            : 'å½“æ—¥ / æ¬¡æ—¥';

        box.innerHTML = `
            <div class="stock-result-title">ğŸ“Š ${marketName} ${data.symbol} Â· è‚¡å¸‚ç›˜ä½é¢„æµ‹ï¼ˆç¤ºä¾‹ï¼‰</div>
            <div class="stock-metric-item" style="margin-bottom:12px;">
                <div class="stock-metric-label">é¢„æµ‹å‘¨æœŸ</div>
                <div class="stock-metric-value">${hzText}</div>
            </div>
            <div class="stock-metrics-grid">
                <div class="stock-metric-item">
                    <div class="stock-metric-label">å‚è€ƒåŸºå‡†ç‚¹ä½</div>
                    <div class="stock-metric-value">${data.basePoint}</div>
                </div>
                <div class="stock-metric-item stock-metric-support">
                    <div class="stock-metric-label">é¢„æµ‹æ”¯æ’‘åŒº</div>
                    <div class="stock-metric-value">${data.support}</div>
                </div>
                <div class="stock-metric-item stock-metric-resistance">
                    <div class="stock-metric-label">é¢„æµ‹å‹åŠ›åŒº</div>
                    <div class="stock-metric-value">${data.resistance}</div>
                </div>
                <div class="stock-metric-item">
                    <div class="stock-metric-label">æ¨¡å‹ç½®ä¿¡åº¦ï¼ˆç¤ºä¾‹ï¼‰</div>
                    <div class="stock-metric-value">${data.confidence}%</div>
                </div>
                <div class="stock-metric-item stock-metric-tendency">
                    <div class="stock-metric-label">é¢„æœŸèµ°åŠ¿åˆ¤æ–­</div>
                    <div class="stock-metric-value">${data.tendency}</div>
                </div>
            </div>
            <div class="stock-summary">${data.summary}</div>
        `;

        // K çº¿å›¾ä»…åœ¨ä½¿ç”¨ã€Œå¥‡é—¨ + AI è§£è¯»ã€åæ˜¾ç¤ºï¼Œæ­¤å¤„ä¸è¯·æ±‚ K çº¿
    } catch (e) {
        box.innerHTML = 'âŒ æ— æ³•è¿æ¥é¢„æµ‹æ¥å£ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å·²å¯åŠ¨ã€‚';
    }
}

// å¥‡é—¨ + è‚¡å¸‚ AI ç»¼åˆè§£è¯»
async function runStockQimenAI() {
    const symbol = (document.getElementById('stockSymbol').value || '').trim();
    const market = document.getElementById('stockMarket').value;
    const apiKey = sanitizeApiKey(document.getElementById('apiKey').value);
    const aiBox = document.getElementById('stockAiExplain');

    if (!window._lastPanData) {
        alert('è¯·å…ˆå®Œæˆä¸€æ¬¡å¥‡é—¨æ’ç›˜ï¼ˆä¸Šé¢çš„â€œå¼€å§‹æ’ç›˜ä¸åˆ†æâ€æŒ‰é’®ï¼‰ï¼Œå†è¿›è¡Œè‚¡å¸‚å¥‡é—¨è§£è¯»ã€‚');
        return;
    }
    if (!symbol) {
        alert('è¯·å…ˆè¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œä¾‹å¦‚ 600519ã€000001 æˆ– AAPL');
        return;
    }
    if (!apiKey) {
        alert('è¯·å…ˆåœ¨ä¸Šæ–¹å¡«å†™ DeepSeek API Keyï¼ˆç”¨äºè°ƒç”¨ AI è§£è¯»ï¼‰ã€‚');
        return;
    }
    var stockMode = (document.querySelector('input[name="stockMode"]:checked') || {}).value || 'brief';
    if (stockMode === 'brief') {
        aiBox.style.display = 'block';
        aiBox.innerHTML = '<div class="stock-ai-title">ğŸ“‹ ç®€è¦æ¨¡å¼ Â· ä»…å±•ç¤ºç›˜ä½ä¸ K çº¿</div><div class="brief-mode-tip">å½“å‰ä¸ç”Ÿæˆå¥‡é—¨ AI è§£è¯»ã€‚å¯å…ˆä½¿ç”¨ä¸Šæ–¹ã€Œè‚¡å¸‚ç›˜ä½é¢„æµ‹ã€æŸ¥çœ‹ç›˜ä½ä¸ K çº¿ï¼›å¦‚éœ€è¯¦ç»†è§£è¯»è¯·é€‰æ‹©ã€Œè¯¦ç»†ï¼ˆä»˜è´¹ï¼‰ã€å¹¶å®Œæˆæ”¯ä»˜è§£é”ã€‚</div>';
        return;
    }
    if (stockMode === 'detail') {
        var token = getStoredPaidToken();
        if (!token) {
            showPayModal();
            return;
        }
    }

    aiBox.style.display = 'block';
    aiBox.innerHTML = 'â˜¯ï¸ æ­£åœ¨ç»“åˆå½“å‰å¥‡é—¨ç›˜é¢ä¸è‚¡ç¥¨ä¿¡æ¯è¿›è¡Œ AI è§£è¯»ï¼Œè¯·ç¨å€™...';

    try {
        var stockBody = { panData: window._lastPanData, symbol, market, apiKey };
        if (stockMode === 'detail' && getStoredPaidToken()) stockBody.paidToken = getStoredPaidToken();
        const res = await fetch(API_BASE + '/api/stocks/qimen-interpret', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(stockBody)
        });

        if (!res.ok) {
            const text = await res.text();
            aiBox.innerHTML = 'âŒ å¥‡é—¨è‚¡å¸‚è§£è¯»æ¥å£æŠ¥é”™ï¼š<br><span style="font-size:12px;color:#6b7280;">' + text + '</span>';
            return;
        }

        const json = await res.json();
        const content = json.content || '';

        let zoneHtml = '';
        if (json.qmBasePoint && json.qmSupport && json.qmResistance) {
            zoneHtml = `
            <div class="stock-zone-card">
                <div style="font-weight:600;margin-bottom:8px;">å¥‡é—¨è§†è§’æ¨¡æ‹Ÿç‚¹ä½åŒºé—´ï¼ˆç¤ºä¾‹ï¼‰</div>
                <div class="stock-metrics-grid" style="margin-bottom:8px;">
                    <div class="stock-metric-item"><div class="stock-metric-label">åŸºå‡†ç‚¹ä½çº¦</div><div class="stock-metric-value">${json.qmBasePoint}</div></div>
                    <div class="stock-metric-item stock-metric-support"><div class="stock-metric-label">ä¸‹æ–¹å‚è€ƒåŒº</div><div class="stock-metric-value">${json.qmSupport}</div></div>
                    <div class="stock-metric-item stock-metric-resistance"><div class="stock-metric-label">ä¸Šæ–¹å‚è€ƒåŒº</div><div class="stock-metric-value">${json.qmResistance}</div></div>
                </div>
                ${json.qiComment ? `<div style="margin-bottom:6px;">Â· æ°”æ•°åˆ¤æ–­ï¼š${json.qiComment}</div>` : ''}
                <div class="stock-disclaimer">ï¼ˆä»…ä¸ºå¥‡é—¨è±¡ä¹‰æ¨æ¼”çš„æ¼”ç¤ºæ•°å€¼ï¼Œä¸ä»£è¡¨çœŸå®è¡Œæƒ…æˆ–æŠ•èµ„å»ºè®®ï¼‰</div>
            </div>
        `;
        }

        aiBox.innerHTML =
            '<div class="stock-ai-title">â˜¯ï¸ å¥‡é—¨ Â· è‚¡å¸‚ AI ç»¼åˆè§£è¯»</div>' +
            zoneHtml +
            marked.parse(content);

        // å¥‡é—¨ + AI è§£è¯»å®Œæˆåï¼ŒåŒæ­¥æ˜¾ç¤º K çº¿å›¾ï¼ˆå«å¥‡é—¨åŒºé—´ï¼‰
        var chartWrap = document.getElementById('stockChart');
        if (chartWrap) chartWrap.style.display = 'block';
        try {
            const kRes = await fetch(API_BASE + '/api/stocks/kline', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    symbol,
                    market,
                    points: getKlinePointsByRange()
                })
            });
            if (kRes.ok) {
                const kData = await kRes.json();
                var zone = (json.qmBasePoint != null && json.qmSupport != null && json.qmResistance != null)
                    ? {
                        basePoint: parseFloat(json.qmBasePoint) || 0,
                        support: parseFloat(json.qmSupport) || 0,
                        resistance: parseFloat(json.qmResistance) || 0
                    }
                    : null;
                renderStockKline(kData, zone);
            } else {
                var canvasEl = document.getElementById('stockChartCanvas');
                if (canvasEl) canvasEl.innerHTML = '<div style="padding:16px;font-size:14px;color:#64748b;">K çº¿æ•°æ®æš‚ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚ä¸Šæ–¹æ–‡å­—è§£è¯»æ­£å¸¸ã€‚</div>';
            }
        } catch (e) {
            var canvasEl = document.getElementById('stockChartCanvas');
            if (canvasEl) canvasEl.innerHTML = '<div style="padding:16px;font-size:14px;color:#64748b;">K çº¿åŠ è½½å¤±è´¥ï¼Œä»…æ˜¾ç¤ºä¸Šæ–¹æ–‡å­—è§£è¯»ã€‚</div>';
        }
    } catch (e) {
        aiBox.innerHTML = 'âŒ æ— æ³•è¿æ¥å¥‡é—¨è‚¡å¸‚è§£è¯»æ¥å£ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å·²å¯åŠ¨æˆ–ç½‘ç»œæƒ…å†µã€‚';
    }
}

// é¡¶éƒ¨è§†å›¾åˆ‡æ¢ï¼šå¥‡é—¨é—®äº‹ / è‚¡å¸‚é¢„æµ‹
function switchView(mode) {
    const qm = document.getElementById('qimenSection');
    const st = document.getElementById('stockSection');
    const tq = document.getElementById('tab-qimen');
    const ts = document.getElementById('tab-stock');

    if (mode === 'stock') {
        if (qm) qm.style.display = 'none';
        if (st) st.style.display = 'block';
        if (tq) tq.classList.remove('active');
        if (ts) ts.classList.add('active');
    } else {
        if (qm) qm.style.display = 'block';
        if (st) st.style.display = 'none';
        if (tq) tq.classList.add('active');
        if (ts) ts.classList.remove('active');
    }
}

setDefaultTime();
</script>
</body>
</html>

